<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MedicinaPersonal · Cupo de Pacientes</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --accent:#0ea5a4;
      --accent2:#1d4ed8;
      --danger:#dc2626;
      --ok:#16a34a;
      --shadow: 0 10px 30px rgba(2, 6, 23, .08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(900px 500px at 10% 0%, rgba(29,78,216,.08), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(14,165,164,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1120px;margin:0 auto;padding:26px 18px 40px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:linear-gradient(180deg,#fff, #fbfdff);
    }
    input,select,textarea,button{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(14,165,164,.55);
      box-shadow: 0 0 0 4px rgba(14,165,164,.12);
    }
    textarea{min-height:78px;resize:vertical}
    button{
      cursor:pointer;
      border-color: rgba(14,165,164,.35);
      background: linear-gradient(180deg, rgba(14,165,164,.14), rgba(14,165,164,.08));
    }
    button:hover{filter:brightness(.98)}
    button.secondary{
      border-color: var(--line);
      background: linear-gradient(180deg, #ffffff, #f8fafc);
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .hidden{display:none}
    .list{width:100%;border-collapse:collapse}
    .list th,.list td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px;vertical-align:top}
    .list th{color:var(--muted);font-weight:650;background:linear-gradient(180deg,#fff,#fbfdff)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-size:12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px; padding:2px 6px;
      border:1px solid var(--line);border-radius:8px;background:#fff;
      color:var(--muted);
    }
    .hr{height:1px;background:var(--line);margin:12px 0}
    .toast{
      position:fixed;right:18px;bottom:18px;
      min-width:260px;max-width:420px;
      padding:12px 14px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.96);
      box-shadow: 0 16px 40px rgba(2,6,23,.14);
      backdrop-filter: blur(8px);
    }
    .toast.ok{border-color: rgba(22,163,74,.35)}
    .toast.err{border-color: rgba(220,38,38,.35)}
    .brandmark{
      width:38px;height:38px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(29,78,216,.22), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(14,165,164,.22), transparent 55%),
                  linear-gradient(180deg, #ffffff, #f8fafc);
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 25px rgba(2,6,23,.08);
    }
    .brandmark svg{opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="brandmark" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 2v20M2 12h20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".35"/>
          </svg>
        </div>
        <div>
          <h1>MedicinaPersonal · Cupo de Pacientes</h1>
          <div class="subtitle">Gestión de pacientes, tareas y recordatorios · Acceso por OTP</div>
        </div>
      </div>

      <div class="pill">
        <span id="meLabel" class="muted">No autenticado</span>
        <button id="btnLogout" class="secondary hidden">Salir</button>
      </div>
    </div>

    <!-- LOGIN (no worker, no config) -->
    <div id="loginCard" class="card">
      <h3 style="margin:0 0 6px 0">Acceso</h3>
      <div class="muted">Introduce tu email, solicita un código y valida el acceso.</div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <div class="muted">Email</div>
          <input id="loginEmail" placeholder="doctor@dominio.com" />
          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <button id="btnRequestOtp">Enviar código</button>
            <span class="badge">Caduca en 10 min</span>
          </div>
          <div class="muted small" style="margin-top:8px">
            Si no llega, revisa spam o activa el usuario en <span class="kbd">Users</span>.
          </div>
        </div>

        <div>
          <div class="muted">Código OTP</div>
          <input id="loginCode" placeholder="123456" inputmode="numeric" />
          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <button id="btnVerifyOtp">Entrar</button>
            <button id="btnPasteEmail" class="secondary">Usar email guardado</button>
          </div>
          <div class="muted small" style="margin-top:8px">
            Consejo: guarda tu email una vez y listo.
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appArea" class="hidden">
      <div class="row" style="margin-top:14px">
        <!-- Patients -->
        <div class="card" style="flex:1;min-width:360px">
          <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap;justify-content:space-between">
            <div>
              <h3 style="margin:0 0 6px 0">Pacientes</h3>
              <div class="muted">Buscar y abrir ficha</div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <input id="qPatients" placeholder="Buscar..." />
              <button id="btnRefreshPatients" class="secondary">Actualizar</button>
              <button id="btnNewPatient">+ Nuevo</button>
            </div>
          </div>

          <div class="hr"></div>

          <table class="list">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Contacto</th>
                <th>Estado</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="patientsTbody"></tbody>
          </table>
        </div>

        <!-- Patient pane + tasks -->
        <div class="card" style="flex:1;min-width:360px">
          <h3 style="margin:0 0 6px 0">Ficha / Recordatorios</h3>
          <div class="muted">Crea tareas con fecha objetivo (también se reflejan en el calendario).</div>

          <div id="patientPane" class="hidden" style="margin-top:12px">
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
              <div>
                <div id="pName" style="font-weight:800;font-size:18px"></div>
                <div class="muted small"><span id="pMeta"></span> · <span id="pId"></span></div>
              </div>
              <button id="btnEditPatient" class="secondary">Editar</button>
            </div>

            <div style="margin-top:14px" class="card">
              <h4 style="margin:0 0 10px 0">Nueva tarea</h4>
              <div class="grid2">
                <div>
                  <div class="muted">Título</div>
                  <input id="tTitle" placeholder="Revisión TA / Analítica / Vacuna..." />
                </div>
                <div>
                  <div class="muted">Fecha objetivo</div>
                  <input id="tDue" type="date" />
                </div>
                <div>
                  <div class="muted">Tipo</div>
                  <select id="tType">
                    <option>GENERAL</option>
                    <option>ANALITICA</option>
                    <option>REVISION</option>
                    <option>VACUNA</option>
                    <option>LLAMADA</option>
                    <option>PRUEBA</option>
                  </select>
                </div>
                <div>
                  <div class="muted">Prioridad</div>
                  <select id="tPri">
                    <option>NORMAL</option>
                    <option>HIGH</option>
                    <option>LOW</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px">
                <div class="muted">Detalles</div>
                <textarea id="tDetails" placeholder="Notas breves (evita datos sensibles innecesarios)"></textarea>
              </div>
              <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
                <button id="btnCreateTask">Crear tarea</button>
                <span class="badge">Se crea evento en Calendar</span>
              </div>
            </div>

            <div style="margin-top:14px">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                <h4 style="margin:0">Tareas pendientes</h4>
                <button id="btnRefreshTasks" class="secondary">Actualizar</button>
              </div>
              <table class="list" style="margin-top:8px">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Tarea</th>
                    <th>Prioridad</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tasksTbody"></tbody>
              </table>
            </div>
          </div>

          <div id="emptyPane" style="margin-top:12px" class="muted">
            Ningún paciente seleccionado.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Worker fijo (el usuario NO introduce nada)
  const WORKER_URL = "https://medicinapersonal.ceo-vlnst.workers.dev";
  const SESS_KEY = "cupo_sessionId";
  const EMAIL_KEY = "cupo_email";

  const el = id => document.getElementById(id);

  async function api(fn, args){
    const payload = { fn, args: args || {}, meta: { ua: navigator.userAgent } };
    const res = await fetch(WORKER_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Error");
    return data;
  }

  // Toast
  let toastTimer=null;
  function escapeHtml(s){
    return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function toast(msg, ok){
    clearTimeout(toastTimer);
    const d=document.createElement("div");
    d.className="toast " + (ok ? "ok":"err");
    d.innerHTML = "<div style='font-weight:800;margin-bottom:4px'>" + (ok?"OK":"Error") + "</div><div>"+escapeHtml(msg)+"</div>";
    document.body.appendChild(d);
    toastTimer=setTimeout(()=>{ d.remove(); }, 3200);
  }

  // Auth
  const btnLogout = el("btnLogout");
  const meLabel = el("meLabel");
  const loginCard = el("loginCard");
  const appArea = el("appArea");

  function getSessionId(){ return localStorage.getItem(SESS_KEY) || ""; }
  function setSessionId(v){ localStorage.setItem(SESS_KEY, v||""); }
  function setEmail(v){ localStorage.setItem(EMAIL_KEY, v||""); }

  async function refreshMe(){
    const sessionId = getSessionId();
    if(!sessionId){
      meLabel.textContent = "No autenticado";
      btnLogout.classList.add("hidden");
      loginCard.classList.remove("hidden");
      appArea.classList.add("hidden");
      return;
    }
    try{
      const me = await api("auth.me", { sessionId });
      meLabel.textContent = me.email + " · " + me.role;
      btnLogout.classList.remove("hidden");
      loginCard.classList.add("hidden");
      appArea.classList.remove("hidden");
      await refreshPatients();
    }catch(err){
      setSessionId("");
      toast(err.message, false);
      meLabel.textContent = "No autenticado";
      btnLogout.classList.add("hidden");
      loginCard.classList.remove("hidden");
      appArea.classList.add("hidden");
    }
  }

  el("btnRequestOtp").onclick = async () => {
    try{
      const email = (el("loginEmail").value||"").trim().toLowerCase();
      if(!email) return toast("Introduce un email", false);
      await api("auth.requestOtp", { email });
      setEmail(email);
      toast("Código enviado a " + email, true);
    }catch(err){ toast(err.message, false); }
  };

  el("btnVerifyOtp").onclick = async () => {
    try{
      const email = (el("loginEmail").value||localStorage.getItem(EMAIL_KEY)||"").trim().toLowerCase();
      const code = (el("loginCode").value||"").trim();
      if(!email || !code) return toast("Email y código requeridos", false);
      const res = await api("auth.verifyOtp", { email, code });
      setSessionId(res.sessionId);
      toast("Sesión iniciada", true);
      await refreshMe();
    }catch(err){ toast(err.message, false); }
  };

  el("btnPasteEmail").onclick = () => {
    const email = (localStorage.getItem(EMAIL_KEY)||"").trim();
    if(!email) return toast("No hay email guardado", false);
    el("loginEmail").value = email;
    toast("Email cargado", true);
  };

  btnLogout.onclick = () => {
    setSessionId("");
    toast("Sesión cerrada", true);
    refreshMe();
  };

  // Patients UI
  const patientsTbody = el("patientsTbody");
  const tasksTbody = el("tasksTbody");
  const qPatients = el("qPatients");
  let currentPatientId = "";

  function setCurrentPatient(p){
    currentPatientId = p ? p.patientId : "";
    if(!p){
      el("patientPane").classList.add("hidden");
      el("emptyPane").classList.remove("hidden");
      return;
    }
    el("emptyPane").classList.add("hidden");
    el("patientPane").classList.remove("hidden");
    el("pName").textContent = p.name || "";
    el("pMeta").textContent = [p.dob||"", p.sex||"", p.phone||"", p.email||""].filter(Boolean).join(" · ");
    el("pId").textContent = p.patientId;
    refreshTasks();
  }

  async function refreshPatients(){
    const sessionId = getSessionId();
    const q = (qPatients.value||"").trim();
    const res = await api("patients.list", { sessionId, q });
    const rows = res.patients || [];
    patientsTbody.innerHTML = rows.map(p => `
      <tr>
        <td><div style="font-weight:800">${escapeHtml(p.name||"")}</div><div class="muted small">${escapeHtml(p.patientId||"")}</div></td>
        <td class="muted">${escapeHtml([p.phone||"", p.email||""].filter(Boolean).join(" · "))}</td>
        <td>${escapeHtml(p.status||"")}</td>
        <td><button class="secondary" data-open="${escapeHtml(p.patientId)}">Abrir</button></td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="muted" style="padding:12px">Sin pacientes</td></tr>`;

    patientsTbody.querySelectorAll("button[data-open]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          const pid = b.getAttribute("data-open");
          const got = await api("patients.get", { sessionId, patientId: pid });
          setCurrentPatient(got.patient);
        }catch(err){ toast(err.message, false); }
      };
    });
  }

  el("btnRefreshPatients").onclick = refreshPatients;
  qPatients.onkeydown = (e)=>{ if(e.key==="Enter") refreshPatients(); };

  el("btnNewPatient").onclick = async () => {
    const sessionId = getSessionId();
    const name = prompt("Nombre y apellidos del paciente:");
    if(!name) return;
    try{
      const res = await api("patients.create", { sessionId, name, status:"ACTIVE" });
      toast("Paciente creado", true);
      await refreshPatients();
      const got = await api("patients.get", { sessionId, patientId: res.patientId });
      setCurrentPatient(got.patient);
    }catch(err){ toast(err.message, false); }
  };

  el("btnEditPatient").onclick = async () => {
    const sessionId = getSessionId();
    if(!currentPatientId) return;
    try{
      const got = await api("patients.get", { sessionId, patientId: currentPatientId });
      const p = got.patient;
      const name = prompt("Nombre", p.name||"");
      if(name===null) return;
      const phone = prompt("Teléfono", p.phone||"");
      if(phone===null) return;
      const email = prompt("Email", p.email||"");
      if(email===null) return;
      const notes = prompt("Notas (breve)", p.notes||"");
      if(notes===null) return;
      await api("patients.update", { sessionId, patientId: currentPatientId, name, phone, email, notes });
      toast("Paciente actualizado", true);
      await refreshPatients();
      const again = await api("patients.get", { sessionId, patientId: currentPatientId });
      setCurrentPatient(again.patient);
    }catch(err){ toast(err.message, false); }
  };

  // Tasks UI
  async function refreshTasks(){
    const sessionId = getSessionId();
    if(!currentPatientId) return;
    const res = await api("tasks.list", { sessionId, patientId: currentPatientId, status:"PENDING", limit: 200 });
    const rows = res.tasks || [];
    tasksTbody.innerHTML = rows.map(t => `
      <tr>
        <td>${escapeHtml(t.dueDate||"")}</td>
        <td>
          <div style="font-weight:800">${escapeHtml(t.title||"")}</div>
          <div class="muted small">${escapeHtml(t.type||"")}${t.details?(" · "+escapeHtml(t.details)):""}</div>
        </td>
        <td>${escapeHtml(t.priority||"")}</td>
        <td style="white-space:nowrap">
          <button class="secondary" data-done="${escapeHtml(t.taskId)}">Hecho</button>
          <button class="secondary" data-snooze="${escapeHtml(t.taskId)}">Posponer</button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="muted" style="padding:12px">Sin tareas pendientes</td></tr>`;

    tasksTbody.querySelectorAll("button[data-done]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          await api("tasks.complete", { sessionId, taskId: b.getAttribute("data-done") });
          toast("Marcada como hecha", true);
          refreshTasks();
        }catch(err){ toast(err.message, false); }
      };
    });

    tasksTbody.querySelectorAll("button[data-snooze]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          const nd = prompt("Nueva fecha (YYYY-MM-DD):");
          if(!nd) return;
          await api("tasks.snooze", { sessionId, taskId: b.getAttribute("data-snooze"), newDueDate: nd });
          toast("Pospuesta", true);
          refreshTasks();
        }catch(err){ toast(err.message, false); }
      };
    });
  }

  el("btnRefreshTasks").onclick = refreshTasks;

  el("btnCreateTask").onclick = async () => {
    const sessionId = getSessionId();
    if(!currentPatientId) return toast("Selecciona un paciente", false);
    const title = (el("tTitle").value||"").trim();
    const dueDate = (el("tDue").value||"").trim();
    const type = (el("tType").value||"").trim();
    const priority = (el("tPri").value||"").trim();
    const details = (el("tDetails").value||"").trim();
    if(!title || !dueDate) return toast("Título y fecha requeridos", false);

    try{
      await api("tasks.create", { sessionId, patientId: currentPatientId, title, dueDate, type, priority, details });
      el("tTitle").value=""; el("tDetails").value="";
      toast("Tarea creada", true);
      refreshTasks();
    }catch(err){ toast(err.message, false); }
  };

  // init
  refreshMe();
})();
</script>
</body>
</html>
